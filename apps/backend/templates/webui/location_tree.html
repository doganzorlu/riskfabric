{% extends "webui/base.html" %}
{% load i18n %}
{% block content %}
<div x-data="{ query: '' }">
<div class="card">
  <h1>{% trans "Location and Asset Tree" %}</h1>
  <p>{% trans "Tree view for Business Unit -> Cost Center -> Section -> Asset with risk counters." %}</p>
  <form method="get" class="inline-grid">
    <div>
      <label>{% trans "Business Unit" %}</label>
      <select name="business_unit_code">
        <option value="">{% trans "All" %}</option>
        {% for bu in business_units %}
          <option value="{{ bu.code }}" {% if selected_business_unit_code == bu.code %}selected{% endif %}>{{ bu.code }} - {{ bu.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>{% trans "Cost Center" %}</label>
      <select name="cost_center_code">
        <option value="">{% trans "All" %}</option>
        {% for cc in cost_centers %}
          <option value="{{ cc.code }}" {% if selected_cost_center_code == cc.code %}selected{% endif %}>{{ cc.code }} - {{ cc.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>{% trans "Section" %}</label>
      <select name="section_code">
        <option value="">{% trans "All" %}</option>
        {% for sec in sections %}
          <option value="{{ sec.code }}" {% if selected_section_code == sec.code %}selected{% endif %}>{{ sec.code }} - {{ sec.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>{% trans "Asset Type" %}</label>
      <select name="asset_type_code">
        <option value="">{% trans "All" %}</option>
        {% for asset_type in asset_types %}
          <option value="{{ asset_type.code }}" {% if selected_asset_type_code == asset_type.code %}selected{% endif %}>{{ asset_type.code }} - {{ asset_type.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>{% trans "Status" %}</label>
      <select name="status">
        <option value="">{% trans "All" %}</option>
        {% for value, label in risk_status_choices %}
          <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>{% trans "Owner" %}</label>
      <input type="text" name="owner" value="{{ selected_owner }}" />
    </div>
    <div>
      <label>{% trans "Due Date From" %}</label>
      <input type="date" name="due_date_from" value="{{ due_date_from }}" />
    </div>
    <div>
      <label>{% trans "Due Date To" %}</label>
      <input type="date" name="due_date_to" value="{{ due_date_to }}" />
    </div>
    <div class="actions">
      <button type="submit" class="btn btn-primary">{% trans "Apply Filter" %}</button>
    </div>
  </form>
  <div class="inline-grid">
    <div>
      <input id="tree-query" type="text" x-model="query" placeholder="{% trans 'Type code or name' %}" aria-label="{% trans 'Quick Search' %}" />
    </div>
  </div>
</div>

<div class="card tree">
  <ul>
    {% for bu in tree %}
      <li x-data="{ open: true }"
          x-show="'{{ bu.business_unit.code|escapejs }} {{ bu.business_unit.name|escapejs }}'.toLowerCase().includes(query.toLowerCase()) || query === ''">
        <button type="button" @click="open = !open">{{ bu.business_unit.code }} - {{ bu.business_unit.name }}</button>
        <span class="pill">{% trans "Total" %}: {{ bu.total_risks }}</span>
        <span class="pill">{% trans "Open" %}: {{ bu.open_risks }}</span>
        <ul x-show="open">
          {% for cc in bu.cost_centers %}
            <li x-data="{ open: false }">
              <button type="button" @click="open = !open">{{ cc.cost_center.code }} - {{ cc.cost_center.name }}</button>
              <span class="pill">{% trans "Total" %}: {{ cc.total_risks }}</span>
              <span class="pill">{% trans "Open" %}: {{ cc.open_risks }}</span>
              <ul x-show="open">
                {% for sec in cc.sections %}
                  <li x-data="{ open: false }">
                    <button type="button" @click="open = !open">{{ sec.section.code }} - {{ sec.section.name }}</button>
                    <span class="pill">{% trans "Total" %}: {{ sec.total_risks }}</span>
                    <span class="pill">{% trans "Open" %}: {{ sec.open_risks }}</span>
                    <ul x-show="open">
                      {% for a in sec.assets %}
                        <li x-show="'{{ a.asset.asset_code|escapejs }} {{ a.asset.asset_name|escapejs }}'.toLowerCase().includes(query.toLowerCase()) || query === ''">
                          {{ a.asset.asset_code }} - {{ a.asset.asset_name }}
                          {% if a.asset.asset_type %}({{ a.asset.asset_type.code }}){% endif %}
                          <span class="pill">{% trans "Total" %}: {{ a.total_risks }}</span>
                          <span class="pill">{% trans "Open" %}: {{ a.open_risks }}</span>
                        </li>
                      {% empty %}
                        <li>{% trans "No assets." %}</li>
                      {% endfor %}
                    </ul>
                  </li>
                {% empty %}
                  <li>{% trans "No sections." %}</li>
                {% endfor %}
              </ul>
            </li>
          {% empty %}
            <li>{% trans "No cost centers." %}</li>
          {% endfor %}
        </ul>
      </li>
    {% empty %}
      <li>{% trans "No business units found." %}</li>
    {% endfor %}
  </ul>
</div>
</div>
{% endblock %}
