{% load i18n %}
<div class="card">
  <h2>{% trans "Risk Distribution by Section" %}</h2>
  <canvas id="location-risk-chart" height="150"></canvas>
  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>{% trans "Business Unit" %}</th>
        <th>{% trans "Cost Center" %}</th>
        <th>{% trans "Section" %}</th>
        <th>{% trans "Total Risks" %}</th>
        <th>{% trans "Open Risks" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for row in by_section %}
      <tr>
        <td>{{ row.business_unit__code }}</td>
        <td>{{ row.cost_center__code }}</td>
        <td>{{ row.section__code }}</td>
        <td>{{ row.total_risks }}</td>
        <td>{{ row.open_risks }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="5">{% trans "No risk distribution data." %}</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card">
  <h2>{% trans "Risks" %}</h2>
  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>{% trans "ID" %}</th>
        <th>{% trans "Title" %}</th>
        <th>{% trans "Status" %}</th>
        <th>{% trans "Owner" %}</th>
        <th>{% trans "Due Date" %}</th>
        <th>{% trans "Primary Asset" %}</th>
        <th>{% trans "Business Unit" %}</th>
        <th>{% trans "Cost Center" %}</th>
        <th>{% trans "Section" %}</th>
        <th>{% trans "Asset Type" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for risk in risks %}
      <tr>
        <td>{{ risk.id }}</td>
        <td>{{ risk.title }}</td>
        <td>{{ risk.get_status_display }}</td>
        <td>{{ risk.owner }}</td>
        <td>{{ risk.due_date }}</td>
        <td>{{ risk.primary_asset.asset_code }}</td>
        <td>{% if risk.business_unit %}{{ risk.business_unit.code }}{% endif %}</td>
        <td>{% if risk.cost_center %}{{ risk.cost_center.code }}{% endif %}</td>
        <td>{% if risk.section %}{{ risk.section.code }}{% endif %}</td>
        <td>{% if risk.asset_type %}{{ risk.asset_type.code }}{% endif %}</td>
      </tr>
      {% empty %}
      <tr><td colspan="10">{% trans "No risks for selected location filters." %}</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{{ section_labels|json_script:"location-section-labels" }}
{{ section_total_values|json_script:"location-section-total-values" }}
{{ section_open_values|json_script:"location-section-open-values" }}
<script>
  (function () {
    const labelsNode = document.getElementById("location-section-labels");
    const totalNode = document.getElementById("location-section-total-values");
    const openNode = document.getElementById("location-section-open-values");
    const canvas = document.getElementById("location-risk-chart");
    if (!labelsNode || !totalNode || !openNode || !canvas || typeof Chart === "undefined") {
      return;
    }

    const labels = JSON.parse(labelsNode.textContent);
    const totals = JSON.parse(totalNode.textContent);
    const opens = JSON.parse(openNode.textContent);
    if (!labels.length) {
      return;
    }

    if (window.locationRiskChart) {
      window.locationRiskChart.destroy();
    }
    window.locationRiskChart = new Chart(canvas, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [
          { label: "{% trans "Total" %}", data: totals, backgroundColor: "#0f5f94" },
          { label: "{% trans "Open" %}", data: opens, backgroundColor: "#f59e0b" }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
  })();
</script>
