{% load i18n %}
<div class="card">
  <h2>{% trans "Linked Assets" %}</h2>
  <p class="muted">
    {% trans "Primary asset is always linked. Select additional assets impacted by this risk." %}
  </p>
  {% if can_manage_risks %}
  <form method="post"
        hx-post="{% url 'webui:risk-detail' risk.id %}"
        hx-target="#risk-linked-assets"
        hx-swap="outerHTML">
    {% csrf_token %}
    <input type="hidden" name="action" value="link_assets" />
    <input id="asset-filter" type="text" placeholder="{% trans 'Type to filter assets' %}" aria-label="{% trans 'Search Assets' %}" />
    <p class="muted" id="asset-filter-count"></p>
    {{ link_form.as_p }}
    <button type="submit" class="btn btn-primary">{% trans "Update Linked Assets" %}</button>
    <a href="{% url 'webui:risk-detail' risk.id %}" class="btn btn-outline-secondary">{% trans "Cancel" %}</a>
  </form>
  {% else %}
  <p class="muted">{% trans "You do not have permission to update linked assets." %}</p>
  {% endif %}
  <div class="card" style="margin-top: 12px;">
    <h3>{% trans "Current Links" %}</h3>
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>{% trans "Asset" %}</th>
          <th>{% trans "Primary" %}</th>
        </tr>
      </thead>
      <tbody>
        {% for link in risk.risk_assets.all %}
        <tr>
          <td>{{ link.asset.asset_code }} - {{ link.asset.asset_name }}</td>
          <td>{% if link.is_primary %}{% trans "Yes" %}{% else %}{% trans "No" %}{% endif %}</td>
        </tr>
        {% empty %}
        <tr><td colspan="2">{% trans "No linked assets found." %}</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script>
  (function () {
    const filterInput = document.getElementById("asset-filter");
    const select = document.getElementById("id_link-asset_ids");
    const countNode = document.getElementById("asset-filter-count");
    if (!filterInput || !select || !countNode) {
      return;
    }

    const options = Array.from(select.options);
    const render = () => {
      const term = filterInput.value.trim().toLowerCase();
      let visibleCount = 0;
      options.forEach(option => {
        const match = option.text.toLowerCase().includes(term);
        option.hidden = !match;
        if (match) {
          visibleCount += 1;
        }
      });
      countNode.textContent = term
        ? `${visibleCount} {% trans "assets match" %}`
        : `{% trans "Showing all assets" %}`;
    };

    filterInput.addEventListener("input", render);
    render();
  })();
</script>
